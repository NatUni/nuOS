#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.12.999a0 - bin/nu_clock
#
# Copyright (c) 2008-2024 Chad Jacob Milios and Crop Circle Systems.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Simplified BSD License.
# If a copy of the Simplified BSD License was not distributed alongside this file, you can
# obtain one at https://www.freebsd.org/copyright/freebsd-license.html . This software
# project is not affiliated with the FreeBSD Project.
#
# Official updates and community support available at https://nuos.org .
# Professional services available at https://ccsys.com .

NUOS_VER=0.0.12.999a0

while getopts blmn:osv: OPT; do case $OPT in
	b) OPT_BLINK=y;;
	l) OPT_LOGIN=y;;
	m) OPT_NO_SECONDS=y;;
	n) NOM=$OPTARG;;
	o) OPT_ONCE=y;;
	s) OPT_SPCSEP=y;;
	v) NMR=$OPTARG;;
esac; done; shift $(($OPTIND-1))

: ${NOM=nuOS}
: ${NMR=`echo $NUOS_VER | /usr/bin/sed -Ee 's/^0\.//;s/^0\.//;s/[a-zA-Z]+[0-9]+$//'`}


if [ -n "${OPT_LOGIN-}" ]; then
	eval "TTY=\"/dev/\$$#\""
	case "$TTY" in
		/dev/tty*)
			exec 0<"$TTY"
			exec 1>"$TTY"
			exec 2>"$TTY"
		;;
		*)
			exit 1
		;;
	esac
fi

if [ -t 1 ]; then
	trm=y
	export TERM=${TERM:-vt100}
else
	echo "$NOM"
	echo "$NMR"
fi

logo () {
	/usr/local/bin/tdfiglet -jr -f breachx -w $(($W - 5)) "$NOM" && /usr/local/bin/tdfiglet -jr -w $(($W - 11)) -f cartoon "$NMR"
}

if [ -n "${OPT_BLINK-}" ]; then
	pause=500
else
	pause=1000
fi

while
	{ read -r W; read -r H; } <<EOF
`[ -n "${trm-}" ] && /usr/bin/tput cols lines || /usr/bin/printf "80\n24\n"`
EOF
	if [ $W != "${w-}" ]; then
		w=$W
		l=`logo`
	fi
	if [ $H != "${h-}" ]; then
		h=$H
		s=
		i=24
		while [ $i -lt $H ]; do
			s=$s$'\n'
			i=$(($i + 2))
		done
	fi
	t=`/usr/local/bin/gdate +%T.%3N`
	ms=${t##*.}
	ms=${ms#0}
	ms=${ms#0}
	time=${t%.*}
	time=${time#0}
	if srsly ${OPT_NO_SECONDS-} || [ $(($W + $H)) -lt 110 ]; then
		time=${time%:*}
	fi
	if [ -n "${OPT_SPCSEP-}" ] || [ -n "${OPT_BLINK-}" -a $ms -ge $pause ]; then
		time=`echo $time | tr : ' '`
	fi
	/usr/local/bin/ghead -c -1 <<EOF

$t



$s$(/usr/local/bin/tdfiglet -jc -w $(($W - 9)) -W3 -f ${CLOCK_FONT:-cyanidx} "$time")$s
$l
EOF
	[ -z "${OPT_ONCE-}" ] || { echo && exit; };
do
	if [ -n "${OPT_LOGIN-}" ]; then
		timeout .$(($pause - $ms))s sh -c 'read -r -t 1 _' && \
			/usr/bin/env TERM=${TERM:-vt100} /usr/bin/clear && \
			exec /usr/libexec/getty "$@" && \
			exit
	else
		sleep .$(($pause - ($ms % $pause))) || echo $pause $ms
	fi
done
