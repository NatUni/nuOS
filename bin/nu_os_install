#!/bin/sh
set -e; set -u; set -C

# nuOS 0.0.12.99a0 - bin/nu_os_install
#
# Copyright (c) 2008-2022 Chad Jacob Milios and Crop Circle Systems.
# All rights reserved.
#
# This Source Code Form is subject to the terms of the Simplified BSD License.
# If a copy of the Simplified BSD License was not distributed alongside this file, you can
# obtain one at https://www.freebsd.org/copyright/freebsd-license.html . This software
# project is not affiliated with the FreeBSD Project.
#
# Official updates and community support available at https://nuos.org .
# Professional services available at https://ccsys.com .

NUOS_VER=0.0.12.99a0

. "$(dirname "$(realpath "$0")")/../lib/nu_system.sh"

while getopts c:i:o:p:P:qv OPT; do case $OPT in
	c) PKG_COLLECTION=$OPTARG;;
	i) INPUT=$OPTARG;;
	o) OUTPUT=$OPTARG;;
	p) POOL_NAME=$OPTARG;;
	P) SOURCE_POOL=$OPTARG;;
	q) OPT_QUICK=y;;
	v) OPT_VERBOSE=y;;
esac; done; shift $(($OPTIND-1))
[ $# = 0 ]

load_lib nu_admin nu_make nu_ports nu_collection nu_install

baseos_init
nuos_init
make_vars_init
collection_vars_init

if canhas ${INPUT-}; then
	echo 'input file      -i INPUT          ' $INPUT
else
	echo 'source pool     -P SOURCE_POOL    ' ${SOURCE_POOL:=$POOL_BOOT_NAME}
fi

if canhas ${OUTPUT-}; then
	echo 'output file     -o OUTPUT         ' $OUTPUT
else
	echo 'target pool     -p POOL_NAME      ' $POOL_NAME
# 	POOL_MNT=`zpool get -H -o value altroot $POOL_NAME`
# 	[ -n "$POOL_MNT" -a x- != "x$POOL_MNT" ]
fi

maybe_pause
maybe_yell

[ -z "${INPUT-}" -o -z "${OUTPUT-}" ]
[ "${SOURCE_POOL-}" != "${POOL_NAME-}" ]

os_software_ds_name=os

fbsd_proj_ds_name=$os_software_ds_name/$BASEOS_TYPE
fbsd_os_ds_name=$fbsd_proj_ds_name/$BASEOS_VER
fbsd_bin_ds_name=$fbsd_os_ds_name/$TRGT

nuos_proj_ds_name=$os_software_ds_name/nuOS
nuos_os_ds_name=$nuos_proj_ds_name/$NUOS_VER
nuos_bin_ds_name=$nuos_os_ds_name/$TRGT

if canhas ${INPUT-}; then
	require_tmp restore_log
	sister nu_restore -t $POOL_NAME < "$INPUT" | tee -a "$restore_log"
	src_rev=`grep "^$POOL_NAME/$nuos_bin_ds_name/" "$restore_log" | cut -d / -f 6 | cut -d @ -f 1 | head -n 1`
else
	src_rev=`zfs get -H -p -o value org.nuos:active_revision $SOURCE_POOL/$nuos_bin_ds_name`
fi

nuos_sysroot_source_ds=$nuos_bin_ds_name/$src_rev

if canhas ${OUTPUT-}; then
	sister nu_backup -p $SOURCE_POOL $nuos_sysroot_source_ds@$PKG_COLLECTION > "$OUTPUT"
	echo "Saved installation zstream."
	exit
elif ! canhas ${INPUT-}; then
	sister nu_backup -p $SOURCE_POOL $nuos_sysroot_source_ds@$PKG_COLLECTION | sister nu_restore -t $POOL_NAME
fi




# XXX: GARBANZO

# BECAUSE https://github.com/zfsonlinux/zfs/pull/5189 SEEMS to be not included in FBSD 11.2
zfs set org.nuos:active_revision=$src_rev $POOL_NAME/$nuos_bin_ds_name
if canhas ${INPUT-}; then
	fbsd_src_rev=`grep "^$POOL_NAME/$fbsd_bin_ds_name/" "$restore_log" | cut -d / -f 6 | cut -d @ -f 1 | head -n 1`
else
	fbsd_src_rev=`basename $(zfs get -H -p -o value origin $SOURCE_POOL/$nuos_sysroot_source_ds) | cut -d @ -f 1`
fi
zfs set org.nuos:active_revision=$fbsd_src_rev $POOL_NAME/$fbsd_bin_ds_name

# /XXX: GARBANZO

# zfs get canmount \
# 	$POOL_NAME/$os_software_ds_name \
# 	$POOL_NAME/$fbsd_proj_ds_name \
# 	$POOL_NAME/$fbsd_os_ds_name \
# 	$POOL_NAME/$fbsd_bin_ds_name \
# 	$POOL_NAME/$fbsd_bin_ds_name/$fbsd_src_rev \
# 	$POOL_NAME/$nuos_proj_ds_name \
# 	$POOL_NAME/$nuos_os_ds_name \
# 	$POOL_NAME/$nuos_bin_ds_name \
# 	$POOL_NAME/$nuos_bin_ds_name/$src_rev

zfs create -p -o setuid=off -o mountpoint=none -o canmount=off $POOL_NAME/$fbsd_proj_ds_name/src
zfs create -o mountpoint=/usr/src $POOL_NAME/$fbsd_proj_ds_name/src/$BASEOS_VER && \
	zfs unmount $POOL_NAME/$fbsd_proj_ds_name/src/$BASEOS_VER || true
zfs create -p -o mountpoint=none -o canmount=off $POOL_NAME/$fbsd_proj_ds_name/src/obj
zfs create -p -o mountpoint=none -o canmount=off $POOL_NAME/$fbsd_proj_ds_name/src/obj/$TRGT_CODE
zfs create -o mountpoint=/usr/obj $POOL_NAME/$fbsd_proj_ds_name/src/obj/$TRGT_CODE/$BASEOS_VER && \
	zfs unmount $POOL_NAME/$fbsd_proj_ds_name/src/obj/$TRGT_CODE/$BASEOS_VER || true
zfs create -p -o setuid=off -o mountpoint=none -o canmount=off $POOL_NAME/$fbsd_proj_ds_name/ports
zfs create -o exec=off -o mountpoint=/var/db/portsnap $POOL_NAME/$fbsd_proj_ds_name/ports/snap-db && \
	zfs unmount $POOL_NAME/$fbsd_proj_ds_name/ports/snap-db || true
zfs create -o mountpoint=/usr/ports $POOL_NAME/$fbsd_proj_ds_name/ports/src && \
	zfs unmount $POOL_NAME/$fbsd_proj_ds_name/ports/src || true
zfs create -o exec=off -o mountpoint=/usr/ports/distfiles $POOL_NAME/$fbsd_proj_ds_name/ports/distfiles && \
	zfs unmount $POOL_NAME/$fbsd_proj_ds_name/ports/distfiles || true
zfs create -o setuid=off -o exec=off -o mountpoint=/usr/ports/packages $POOL_NAME/$nuos_bin_ds_name/pkg && \
	zfs unmount $POOL_NAME/$nuos_bin_ds_name/pkg || true

sister nu_build -FN -p $POOL_NAME -c $PKG_COLLECTION -q
